<div class="card mt-4" id="playerStatsWidget" style="display: none;">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>Player Statistics
        </h5>
        <button type="button" class="btn-close" onclick="closePlayerStats()" aria-label="Close"></button>
    </div>
    <div class="card-body">
        <div class="text-center mb-4">
            <h4 id="playerName" class="mb-1"></h4>
            <div id="playerRating" class="text-muted mb-3"></div>
            
            <div class="d-flex justify-content-center gap-4 mb-4">
                <div class="text-center">
                    <div class="h2 mb-1 text-success" id="winsCount">0</div>
                    <div class="text-muted small">Wins</div>
                </div>
                <div class="text-center">
                    <div class="h2 mb-1 text-warning" id="drawsCount">0</div>
                    <div class="text-muted small">Draws</div>
                </div>
                <div class="text-center">
                    <div class="h2 mb-1 text-danger" id="lossesCount">0</div>
                    <div class="text-muted small">Losses</div>
                </div>
                <div class="text-center">
                    <div class="h2 mb-1 text-primary" id="totalPoints">0.0</div>
                    <div class="text-muted small">Points</div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Round</th>
                        <th>Opponent</th>
                        <th>Color</th>
                        <th>Result</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="matchHistoryBody">
                    <!-- Match history will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Close player stats widget
function closePlayerStats() {
    document.getElementById('playerStatsWidget').style.display = 'none';
    // Clear the URL hash
    history.pushState('', document.title, window.location.pathname + window.location.search);
}

// Update player stats based on match history
function updatePlayerStats(history) {
    console.log('Updating player stats with history:', history);
    
    // Safely update element text
    const safeSetText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };

    // Initialize counters
    let wins = 0, draws = 0, losses = 0, totalPoints = 0;
    
    // Check if history is valid
    if (!history || (typeof history !== 'object')) {
        console.warn('Invalid history data:', history);
        safeSetText('winsCount', '0');
        safeSetText('drawsCount', '0');
        safeSetText('lossesCount', '0');
        safeSetText('totalPoints', '0.0');
        return;
    }
    
    // Handle case where history is in a data property
    const historyArray = Array.isArray(history) ? history : 
                        (history.history && Array.isArray(history.history)) ? history.history : [];
    
    console.log(`Processing ${historyArray.length} history items`);
    
    if (historyArray.length === 0) {
        safeSetText('winsCount', '0');
        safeSetText('drawsCount', '0');
        safeSetText('lossesCount', '0');
        safeSetText('totalPoints', '0.0');
        return;
    }
    
    // Process each match
    historyArray.forEach(match => {
        if (!match) return;
        
        const result = String(match.result || '').trim();
        const color = String(match.color || '').toLowerCase().trim();
        
        console.log('Processing match:', { result, color });
        
        if (result === '1-0') {
            if (color === 'white') {
                wins++;
                totalPoints += 1;
            } else if (color === 'black') {
                losses++;
            }
        } else if (result === '0-1') {
            if (color === 'black') {
                wins++;
                totalPoints += 1;
            } else if (color === 'white') {
                losses++;
            }
        } else if (['½-½', '=', '0.5-0.5', '0.5'].includes(result)) {
            draws++;
            totalPoints += 0.5;
        }
    });
    
    console.log(`Stats - Wins: ${wins}, Losses: ${losses}, Draws: ${draws}, Total: ${totalPoints.toFixed(1)}`);
    
    // Update the UI
    safeSetText('winsCount', wins);
    safeSetText('lossesCount', losses);
    safeSetText('drawsCount', draws);
    safeSetText('totalPoints', totalPoints.toFixed(1));
}

// Handle hash changes to show player stats
window.addEventListener('hashchange', function() {
    const match = window.location.hash.match(/^#player-([0-9]+)$/);
    if (match) {
        const playerId = match[1];
        const playerRow = document.querySelector(`tr[data-player-id="${playerId}"]`);
        if (playerRow) {
            const playerName = playerRow.querySelector('.player-name').textContent.trim();
            const playerRating = playerRow.querySelector('.player-rating')?.textContent.trim() || '';
            // Ensure the tournament token is available
            const tournamentToken = '{{ tournament.share_token }}';
            if (!tournamentToken) {
                console.error('Tournament token is missing');
                // Fetch player history with JSON format
            console.log(`Fetching history for player ${playerId}...`);
            // Use the full URL path that matches our route definition
            const url = `/public/t/${tournamentToken}/player/${playerId}/history?format=json`;
            console.log('Using URL:', url);
            } else {
                console.log('Showing history from hash change:', { tournamentToken, playerId, playerName, playerRating });
                showPlayerHistory(tournamentToken, playerId, playerName, playerRating);
            }
        }
    } else {
        closePlayerStats();
    }
});
</script>
