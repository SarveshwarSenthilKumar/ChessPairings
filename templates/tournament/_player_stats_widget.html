<div class="card mt-4" id="playerStatsWidget" style="display: none;">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>Player Statistics
        </h5>
        <button type="button" class="btn-close" onclick="closePlayerStats()" aria-label="Close"></button>
    </div>
    <div class="card-body">
        <div class="text-center mb-4">
            <h4 id="playerName" class="mb-1"></h4>
            <div id="playerRating" class="text-muted mb-3"></div>
            
            <div class="d-flex justify-content-center gap-4 mb-4">
                <div class="text-center">
                    <div class="h2 mb-1 text-success" id="winsCount">0</div>
                    <div class="text-muted small">Wins</div>
                </div>
                <div class="text-center">
                    <div class="h2 mb-1 text-warning" id="drawsCount">0</div>
                    <div class="text-muted small">Draws</div>
                </div>
                <div class="text-center">
                    <div class="h2 mb-1 text-danger" id="lossesCount">0</div>
                    <div class="text-muted small">Losses</div>
                </div>
                <div class="text-center">
                    <div class="h2 mb-1 text-primary" id="totalPoints">0.0</div>
                    <div class="text-muted small">Points</div>
                </div>
            </div>
            <div class="d-flex justify-content-center gap-4 mb-4">
                <div class="text-center">
                    <div class="h4 mb-1 text-info" id="perfRating">-</div>
                    <div class="text-muted small">Perf. Rating</div>
                </div>
                <div class="text-center">
                    <div class="h4 mb-1 text-info" id="avgOpponentRating">-</div>
                    <div class="text-muted small">Avg. Opponent</div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Round</th>
                        <th>Opponent</th>
                        <th>Color</th>
                        <th>Result</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="matchHistoryBody">
                    <!-- Match history will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Close player stats widget
function closePlayerStats() {
    document.getElementById('playerStatsWidget').style.display = 'none';
    // Clear the URL hash
    history.pushState('', document.title, window.location.pathname + window.location.search);
}

// Calculate performance rating based on opponent ratings and results
function calculatePerformanceRating(history) {
    console.log('Calculating performance rating with history:', history);
    
    if (!history || !Array.isArray(history) || history.length === 0) {
        console.log('No valid history provided for performance rating calculation');
        return null;
    }
    
    let totalOpponentRating = 0;
    let totalGames = 0;
    let totalScore = 0;
    
    history.forEach((match, index) => {
        console.log(`Processing match ${index + 1}:`, match);
        
        // Skip invalid matches
        if (!match) {
            console.log('Skipping invalid match (null/undefined)');
            return;
        }
        
        // Check if opponent_rating exists and is a valid number
        const opponentRating = parseInt(match.opponent_rating || match.opponentRating || 0);
        const points = parseFloat(match.points) || 0;
        
        console.log(`Match ${index + 1} - Opponent Rating: ${opponentRating}, Points: ${points}`);
        
        if (opponentRating > 0) {
            totalOpponentRating += opponentRating;
            totalScore += points;
            totalGames++;
            console.log(`Added to calculation - Total Games: ${totalGames}, Total Rating: ${totalOpponentRating}, Total Score: ${totalScore}`);
        } else {
            console.log(`Skipping match - Invalid opponent rating: ${opponentRating}`);
        }
    });
    
    console.log(`Final calculation - Total Games: ${totalGames}, Total Rating: ${totalOpponentRating}, Total Score: ${totalScore}`);
    
    if (totalGames === 0) {
        console.log('No valid games with opponent ratings found');
        return null;
    }
    
    const avgOpponentRating = Math.round(totalOpponentRating / totalGames);
    const scorePercentage = (totalScore / totalGames) * 100;
    
    console.log(`Average Opponent Rating: ${avgOpponentRating}, Score Percentage: ${scorePercentage.toFixed(2)}%`);
    
    // Performance Rating formula: PR = Average Opponent Rating + dp
    // where dp is based on score percentage (dp = -400 * log10(1/scorePercentage - 1))
    // For simplicity, we'll use a lookup table for common values
    const dp = {
        100: 800, 95: 677, 90: 589, 85: 538, 80: 501, 75: 470, 70: 444,
        65: 420, 60: 400, 55: 380, 50: 360, 45: 340, 40: 320, 35: 300,
        30: 280, 25: 260, 20: 240, 15: 220, 10: 200, 0: 0
    };
    
    // Find the closest percentage in the lookup table
    let closestPct = Object.keys(dp).reduce((prev, curr) => {
        return (Math.abs(curr - scorePercentage) < Math.abs(prev - scorePercentage) ? curr : prev);
    });
    
    const performanceRating = Math.round(avgOpponentRating + dp[closestPct]);
    
    return {
        performanceRating: performanceRating,
        avgOpponentRating: avgOpponentRating,
        totalGames: totalGames
    };
}

// Update player stats based on match history
function updatePlayerStats(history) {
    console.log('Updating player stats with history:', history);
    
    // Safely update element text
    const safeSetText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };

    // Initialize counters
    let wins = 0, draws = 0, losses = 0, totalPoints = 0;
    
    // Check if history is valid
    if (!history || (typeof history !== 'object')) {
        console.warn('Invalid history data:', history);
        safeSetText('winsCount', '0');
        safeSetText('drawsCount', '0');
        safeSetText('lossesCount', '0');
        safeSetText('totalPoints', '0.0');
        return;
    }
    
    // Handle case where history is in a data property
    const historyArray = Array.isArray(history) ? history : 
                        (history.history && Array.isArray(history.history)) ? history.history : [];
    
    console.log(`Processing ${historyArray.length} history items`);
    
    if (historyArray.length === 0) {
        safeSetText('winsCount', '0');
        safeSetText('drawsCount', '0');
        safeSetText('lossesCount', '0');
        safeSetText('totalPoints', '0.0');
        return;
    }
    
    // Process each match
    historyArray.forEach(match => {
        if (!match) return;
        
        const result = String(match.result || '').trim();
        const color = String(match.color || '').toLowerCase().trim();
        
        console.log('Processing match:', { result, color });
        
        if (result === '1-0') {
            if (color === 'white') {
                wins++;
                totalPoints += 1;
            } else {
                losses++;
            }
        } else if (result === '0-1') {
            if (color === 'black') {
                wins++;
                totalPoints += 1;
            } else {
                losses++;
            }
        } else if (result === '0.5-0.5' || result === '0.5' || result === '½-½' || result === '=') {
            draws++;
            totalPoints += 0.5;
        }
    
    console.log(`Stats - Wins: ${wins}, Losses: ${losses}, Draws: ${draws}, Total: ${totalPoints.toFixed(1)}`);
    
    // Prepare history data for performance rating calculation
    const historyForRatings = historyArray.map(match => {
        // Calculate points based on result and color, same as in _player_history.html
        let points = 0;
        const result = String(match.result || '').trim();
        const color = String(match.color || '').toLowerCase().trim();
        
        if (result === '1-0') {
            points = (color === 'white') ? 1.0 : 0.0;
        } else if (result === '0-1') {
            points = (color === 'black') ? 1.0 : 0.0;
        } else if (result === '0.5-0.5' || result === '0.5' || result === '½-½' || result === '=') {
            points = 0.5;
        }
        
        return {
            ...match,
            opponent_rating: match.opponent_rating || match.opponentRating,
            points: match.points || points
        };
    });
    
    console.log('History for ratings:', historyForRatings);
    
    // Calculate performance rating and average opponent rating
    const ratings = calculatePerformanceRating(historyForRatings);
    
    // Update the stats display
    safeSetText('winsCount', wins);
    safeSetText('drawsCount', draws);
    safeSetText('lossesCount', losses);
    safeSetText('totalPoints', totalPoints.toFixed(1));
    
    // Update rating stats if available
    if (ratings && ratings.totalGames > 0) {
        safeSetText('perfRating', ratings.performanceRating);
        safeSetText('avgOpponentRating', ratings.avgOpponentRating);
    } else {
        safeSetText('perfRating', '-');
        safeSetText('avgOpponentRating', '-');
    }
}

// Handle hash changes to show player stats
window.addEventListener('hashchange', function() {
    const match = window.location.hash.match(/^#player-([0-9]+)$/);
    if (match) {
        const playerId = match[1];
        const playerRow = document.querySelector(`tr[data-player-id="${playerId}"]`);
        if (playerRow) {
            const playerName = playerRow.querySelector('.player-name').textContent.trim();
            const playerRating = playerRow.querySelector('.player-rating')?.textContent.trim() || '';
            // Ensure the tournament token is available
            const tournamentToken = '{{ tournament.share_token }}';
            if (!tournamentToken) {
                console.error('Tournament token is missing');
                // Fetch player history with JSON format
            console.log(`Fetching history for player ${playerId}...`);
            // Use the full URL path that matches our route definition
            const url = `/public/t/${tournamentToken}/player/${playerId}/history?format=json`;
            console.log('Using URL:', url);
            } else {
                console.log('Showing history from hash change:', { tournamentToken, playerId, playerName, playerRating });
                showPlayerHistory(tournamentToken, playerId, playerName, playerRating);
            }
        }
    } else {
        closePlayerStats();
    }
});
</script>
