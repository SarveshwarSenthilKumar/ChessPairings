{% extends "base.html" %}

{% block title %}Tournaments - Chess Tournament Manager{% endblock %}

{% block extra_css %}
<style>
    /* Mass delete mode styles */
    .mass-delete-mode .tournament-card {
        border: 2px solid var(--bs-danger);
        position: relative;
        overflow: hidden;
    }
    
    .mass-delete-mode .tournament-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(220, 53, 69, 0.05);
        pointer-events: none;
        z-index: 1;
    }
    
    .mass-delete-mode .tournament-card.selected {
        border-color: var(--bs-danger);
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
    }
    
    .mass-delete-mode .tournament-card .form-check-input {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 2;
        width: 1.25rem;
        height: 1.25rem;
        cursor: pointer;
    }
    
    .mass-delete-actions {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: var(--bs-body-bg);
        padding: 10px 20px;
        border-radius: 50px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .mass-delete-mode .mass-delete-actions {
        display: flex;
        gap: 10px;
    }
    .tournament-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .tournament-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .card-header {
        background: linear-gradient(135deg, #0d6efd, #0b5ed7);
        color: white;
        border: none;
    }
    
    .card-footer {
        background-color: transparent;
        border-top: 1px solid var(--card-border);
    }
    
    .badge {
        font-weight: 500;
        padding: 0.5em 0.8em;
    }
    
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: var(--text-muted);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .search-card {
        border: 1px solid var(--card-border);
    }
    
    .progress {
        height: 4px;
        background-color: var(--bs-gray-200);
    }
    
    .progress-bar {
        background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    }
    
    /* Dark mode specific styles */
    [data-bs-theme="dark"] {
        .badge {
            color: white;
        }
        
        .empty-state {
            color: var(--bs-gray-400);
        }
        
        .progress {
            background-color: var(--bs-gray-700);
        }
    }
</style>
{% endblock %}

{% block content %}
{{ super() }}
<!-- Toast Notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <!-- Success Toast -->
    <div id="deleteSuccessToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span class="toast-message">Tournament(s) deleted successfully.</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    
    <!-- Error Toast -->
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span class="toast-message">An error occurred. Please try again.</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Header with actions -->
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-trophy me-2"></i>My Tournaments</h1>
        <div>
            <a href="{{ url_for('tournament.hidden_tournaments') }}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-eye-slash me-1"></i> View Hidden
            </a>
            <button id="toggleMassDelete" class="btn btn-outline-danger me-2">
                <i class="fas fa-trash-alt me-1"></i> Mass Delete
            </button>
            <a href="{{ url_for('tournament.create') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i> New Tournament
            </a>
        </div>
    </div>
</div>

<!-- Mass Delete Actions -->
<div class="mass-delete-actions">
    <button id="deleteSelected" class="btn btn-danger">
        <i class="fas fa-trash-alt me-1"></i> Delete Selected (0)
    </button>
    <button id="cancelMassDelete" class="btn btn-outline-secondary">
        <i class="fas fa-times me-1"></i> Cancel
    </button>
</div>

<!-- Filter and Sort Controls -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <!-- Search -->
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search tournaments by name, location, or status...">
                </div>
            </div>
            
            <!-- Status Filter -->
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="all">All Statuses</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="ongoing">Ongoing</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            
            <!-- Sort By -->
            <div class="col-md-3">
                <select class="form-select" id="sortBy">
                    <option value="recent">Most Recent</option>
                    <option value="oldest">Oldest</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="start_date">Start Date</option>
                    <option value="players_asc">Players (Fewest First)</option>
                    <option value="players_desc">Players (Most First)</option>
                </select>
            </div>
            
            <!-- Reset Button -->
            <div class="col-md-2">
                <button id="resetFilters" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-undo me-1"></i> Reset
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row" id="tournamentsContainer">
    {% if tournaments|length == 0 %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-trophy fa-4x text-muted mb-3"></i>
                <h3>No Tournaments Yet</h3>
                <p class="text-muted">Get started by creating your first tournament</p>
                <a href="{{ url_for('tournament.create') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Create Tournament
                </a>
            </div>
        </div>
    </div>
    {% else %}
    {% for tournament in tournaments %}
    <div class="col-12 col-md-6 col-lg-4 mb-4">
        <div class="card h-100 shadow-sm tournament-card" 
             data-tournament-id="{{ tournament.id }}"
             data-status="{{ tournament.status|default('upcoming') }}"
             data-start-date="{{ tournament.start_date|default('') }}"
             data-created-at="{{ tournament.created_at|default('') }}"
             data-name="{{ tournament.name|lower }}"
             data-location="{{ tournament.location|default('')|lower }}">
                <input type="checkbox" class="form-check-input tournament-checkbox" value="{{ tournament.id }}" style="display: none;">
            <div class="card-header position-relative">
                {% if tournament.via_share_link %}
                <span class="position-absolute top-0 end-0 m-2" data-bs-toggle="tooltip" title="Access via share link">
                    <i class="fas fa-link text-light"></i>
                </span>
                {% endif %}
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 card-title">{{ tournament.name }}</h5>
                    <span class="badge bg-{{ 'success' if tournament.status == 'completed' else 'primary' if tournament.status == 'in_progress' else 'secondary' }}">
                        {{ tournament.status|replace('_', ' ')|title }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-calendar-day me-2 text-muted"></i>
                        <span>{{ tournament.start_date|datetimeformat('%b %d, %Y') }} - {{ tournament.end_date|datetimeformat('%b %d, %Y') }}</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-flag-checkered me-2 text-muted"></i>
                        <span>Rounds: {{ tournament.rounds if tournament.rounds else 'Not set' }}</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users me-2 text-muted"></i>
                        <span data-player-count>{{ tournament.player_count|default(0) }}</span>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{{ url_for('tournament.view', tournament_id=tournament.id) }}" class="btn btn-sm btn-outline-primary">
                            View Tournament
                        </a>
                        {% if tournament.status == 'ongoing' %}
                        <a href="{{ url_for('tournament.manage_pairings', tournament_id=tournament.id) }}" class="btn btn-sm btn-success ms-2">
                            Manage Pairings
                        </a>
                        {% endif %}
                    </div>
                    <button class="btn btn-sm btn-outline-secondary ms-2 hide-tournament" 
                            data-tournament-id="{{ tournament.id }}"
                            title="Hide this tournament">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to delete <span id="deleteCount">0</span> tournament(s). This action cannot be undone.</p>
                <p class="mb-0"><strong>All tournament data, including players, pairings, and results, will be permanently removed.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" id="confirmDelete" class="btn btn-danger">
                    <i class="fas fa-trash-alt me-1"></i> Delete Permanently
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- Tournament Management JS -->
<script src="{{ url_for('static', filename='js/tournament.js') }}"></script>
<script src="{{ url_for('static', filename='js/hide-tournament.js') }}"></script>
<script src="{{ url_for('static', filename='js/tournament-filters.js') }}"></script>

<script>
// Initialize tooltips, modals, and toasts
document.addEventListener('DOMContentLoaded', function() {
    // Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize delete confirmation modal if it exists
    var deleteModalEl = document.getElementById('deleteConfirmationModal');
    if (deleteModalEl) {
        // Initialize the modal
        var deleteModal = new bootstrap.Modal(deleteModalEl);
        
        // Make it available globally for the tournament.js
        window.deleteConfirmationModal = deleteModal;
    }
    
    // Initialize toasts
    var toastElList = [].slice.call(document.querySelectorAll('.toast'));
    toastElList.forEach(function(toastEl) {
        new bootstrap.Toast(toastEl, { autohide: true, delay: 5000 });
    });
    
    // Initialize mass delete functionality
    if (typeof initMassDelete === 'function') {
        initMassDelete();
    }
});

// Setup search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('tournamentSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const tournamentCards = document.querySelectorAll('.tournament-card');
            
            tournamentCards.forEach(card => {
                const name = card.getAttribute('data-name') || '';
                const location = card.getAttribute('data-location') || '';
                const status = card.getAttribute('data-status') || '';
                
                const matches = name.toLowerCase().includes(searchTerm) || 
                              location.toLowerCase().includes(searchTerm) ||
                              status.toLowerCase().includes(searchTerm);
                
                card.style.display = matches ? 'block' : 'none';
                
                // Update the parent row's display if all cards are hidden
                const row = card.closest('.row');
                if (row) {
                    const visibleCards = row.querySelectorAll('.tournament-card[style*="display: block"]');
                    row.style.display = visibleCards.length > 0 ? '' : 'none';
                }
            });
        });
    }
});
</script>
{% endblock %}
