{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Chess Tournament Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-trophy me-2"></i>{{ tournament.name }}
        <span class="badge bg-{{ 'success' if tournament.status == 'ongoing' else 'secondary' }} ms-2">
            {{ tournament.status|title }}
        </span>
    </h1>
    <div>
        <a href="{{ url_for('tournament.manage_players', tournament_id=tournament.id) }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-users me-1"></i> Manage Players
        </a>
        <a href="{{ url_for('tournament.manage_pairings', tournament_id=tournament.id) }}" class="btn btn-primary">
            <i class="fas fa-chess-board me-1"></i> Manage Pairings
        </a>
    </div>
</div>

<!-- Tournament Info -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><i class="far fa-calendar-alt me-2 text-muted"></i> 
                    <strong>Dates:</strong> {{ tournament.start_date|datetimeformat('%b %d, %Y') }} - {{ tournament.end_date|datetimeformat('%b %d, %Y') }}
                </p>
                <p><i class="fas fa-flag-checkered me-2 text-muted"></i> 
                    <strong>Rounds:</strong> {{ tournament.rounds }}
                </p>
                <p><i class="fas fa-users me-2 text-muted"></i> 
                    <strong>Players:</strong> {{ tournament.player_count }}
                </p>
            </div>
            <div class="col-md-6">
                <p><i class="fas fa-clock me-2 text-muted"></i> 
                    <strong>Time Control:</strong> {{ tournament.time_control or 'Not specified' }}
                </p>
                <p><i class="fas fa-map-marker-alt me-2 text-muted"></i> 
                    <strong>Location:</strong> {{ tournament.location or 'Not specified' }}
                </p>
                <p><i class="fas fa-info-circle me-2 text-muted"></i> 
                    <strong>Status:</strong> {{ tournament.status|title }}
                </p>
            </div>
        </div>
        {% if tournament.description %}
        <div class="mt-3">
            <h5>Description</h5>
            <p class="mb-0">{{ tournament.description }}</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Current Round -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chess-king me-2"></i>Current Round
                </h5>
            </div>
            <div class="card-body">
                {% if current_round %}
                    <h6 class="card-subtitle mb-3">
                        Round {{ current_round.round_number }} - {{ current_round.status|title }}
                    </h6>
                    {% if pairings %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Board</th>
                                        <th>White</th>
                                        <th>vs</th>
                                        <th>Black</th>
                                        <th>Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pairing in pairings %}
                                    <tr>
                                        <td>{{ pairing.board_number }}</td>
                                        <td class="{% if pairing.result == '1-0' %}fw-bold{% endif %}">
                                            {{ pairing.white_name }} ({{ pairing.white_rating }})
                                        </td>
                                        <td>vs</td>
                                        <td class="{% if pairing.result == '0-1' %}fw-bold{% endif %}">
                                            {{ pairing.black_name }} ({{ pairing.black_rating }})
                                        </td>
                                        <td>
                                            {% if pairing.result %}
                                                <span class="badge bg-{{ 'success' if pairing.result != '*' else 'secondary' }}">
                                                    {{ pairing.result }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-light text-dark">Pending</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            No pairings available for this round yet.
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning mb-0">
                        No active round. Start a new round to begin the tournament.
                    </div>
                {% endif %}
            </div>
            {% if current_round %}
            <div class="card-footer bg-transparent">
                <a href="{{ url_for('tournament.manage_pairings', tournament_id=tournament.id) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-edit me-1"></i> Manage Pairings
                </a>
                {% if current_round.status == 'ongoing' %}
                    <a href="#" class="btn btn-sm btn-success ms-2" data-bs-toggle="modal" data-bs-target="#completeRoundModal">
                        <i class="fas fa-flag-checkered me-1"></i> Complete Round
                    </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Top Standings -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Current Standings
                </h5>
            </div>
            <div class="card-body p-0">
                {% if standings %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Player</th>
                                    <th class="text-center">Pts</th>
                                    <th class="text-center">TB1</th>
                                    <th class="text-center">TB2</th>
                                    <th class="text-center">Rating</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in standings[:10] %}
                                <tr class="{% if loop.index <= 3 %}table-{{ ['success', 'info', 'warning'][loop.index0] }}{% endif %}">
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <a href="#" class="text-decoration-none">
                                            {{ player.name }}
                                            {% if loop.index <= 3 %}
                                                <span class="badge bg-{{ ['success', 'info', 'warning'][loop.index0] }} ms-1">
                                                    {{ loop.index|ordinal }}
                                                </span>
                                            {% endif %}
                                        </a>
                                    </td>
                                    <td class="text-center fw-bold">{{ player.score }}</td>
                                    <td class="text-center">{{ "%.2f"|format(player.tiebreak1) }}</td>
                                    <td class="text-center">{{ "%.2f"|format(player.tiebreak2) }}</td>
                                    <td class="text-center">{{ player.rating }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if standings|length > 10 %}
                        <div class="text-center py-2 border-top">
                            <a href="{{ url_for('tournament.standings', tournament_id=tournament.id) }}" class="btn btn-sm btn-outline-primary">
                                View Full Standings <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p class="mb-0">No players registered yet.</p>
                    </div>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent">
                <a href="{{ url_for('tournament.standings', tournament_id=tournament.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list-ol me-1"></i> View Full Standings
                </a>
                <a href="{{ url_for('tournament.rounds', tournament_id=tournament.id) }}" class="btn btn-sm btn-outline-secondary ms-2">
                    <i class="fas fa-history me-1"></i> View All Rounds
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Tournament Actions -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Tournament Actions</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                        <h5 class="h6 mb-2">Manage Players</h5>
                        <p class="small text-muted mb-0">Add, remove, or edit tournament participants</p>
                        <a href="{{ url_for('tournament.manage_players', tournament_id=tournament.id) }}" class="stretched-link"></a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-success bg-opacity-10 text-success rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                            <i class="fas fa-chess-board fa-2x"></i>
                        </div>
                        <h5 class="h6 mb-2">Generate Pairings</h5>
                        <p class="small text-muted mb-0">Create pairings for the next round</p>
                        <a href="{{ url_for('tournament.manage_pairings', tournament_id=tournament.id) }}" class="stretched-link"></a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-info bg-opacity-10 text-info rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                            <i class="fas fa-file-export fa-2x"></i>
                        </div>
                        <h5 class="h6 mb-2">Export Results</h5>
                        <p class="small text-muted mb-0">Download tournament data in various formats</p>
                        <a href="#" class="stretched-link" data-bs-toggle="modal" data-bs-target="#exportModal"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Complete Round Modal -->
<div class="modal fade" id="completeRoundModal" tabindex="-1" aria-labelledby="completeRoundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="completeRoundModalLabel">Complete Round {{ current_round.round_number }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to complete the current round? This will:</p>
                <ul>
                    <li>Finalize all results</li>
                    <li>Update player ratings</li>
                    <li>Make the round results permanent</li>
                </ul>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmComplete">
                    <label class="form-check-label" for="confirmComplete">
                        I confirm all results have been entered correctly
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="completeRoundBtn" disabled>
                    <i class="fas fa-flag-checkered me-1"></i> Complete Round
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exportModalLabel">Export Tournament Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportFormat" class="form-label">Select Format</label>
                    <select class="form-select" id="exportFormat">
                        <option value="csv">CSV (Excel)</option>
                        <option value="pgn">PGN (Chess Games)</option>
                        <option value="json">JSON (Raw Data)</option>
                        <option value="html">HTML (Web Page)</option>
                    </select>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeGames" checked>
                    <label class="form-check-label" for="includeGames">
                        Include game moves (where applicable)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="exportBtn">
                    <i class="fas fa-download me-1"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Danger Zone - Only show to creator -->
{% if session.get('user_id') == tournament.creator_id %}
<div class="card border-danger mb-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Danger Zone</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-danger">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h6 class="alert-heading">Delete This Tournament</h6>
                    <p class="mb-0">This action cannot be undone. All tournament data including players, rounds, and pairings will be permanently deleted.</p>
                </div>
                <button type="button" class="btn btn-outline-danger ms-3" data-bs-toggle="modal" data-bs-target="#deleteTournamentModal">
                    <i class="fas fa-trash-alt me-1"></i> Delete Tournament
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTournamentModal" tabindex="-1" aria-labelledby="deleteTournamentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTournamentModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the tournament <strong>{{ tournament.name }}</strong>? This action cannot be undone.</p>
                <p class="text-danger"><strong>Warning:</strong> All tournament data including players, rounds, and pairings will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <form action="{{ url_for('tournament.delete_tournament', tournament_id=tournament.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Delete Permanently
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enable/disable complete round button based on confirmation
    const confirmComplete = document.getElementById('confirmComplete');
    const completeRoundBtn = document.getElementById('completeRoundBtn');
    
    if (confirmComplete && completeRoundBtn) {
        confirmComplete.addEventListener('change', function() {
            completeRoundBtn.disabled = !this.checked;
        });
        
        completeRoundBtn.addEventListener('click', function() {
            // Add your complete round logic here
            // For example, submit a form or make an AJAX call
            alert('Round completed successfully!');
            $('#completeRoundModal').modal('hide');
            // Reload the page to show updated data
            window.location.reload();
        });
    }
    
    // Export button handler
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const format = document.getElementById('exportFormat').value;
            const includeGames = document.getElementById('includeGames').checked;
            
            // Add your export logic here
            alert(`Exporting as ${format.toUpperCase()} (Include Games: ${includeGames})`);
            $('#exportModal').modal('hide');
            
            // Example of how you might trigger a download
            // window.location.href = `/tournaments/{{ tournament.id }}/export?format=${format}&include_games=${includeGames}`;
        });
    }
});
</script>
{% endblock %}
{% endblock %}
