{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Chess Tournament Manager{% endblock %}

{% block extra_css %}
<style>
    /* Print styles */
    @media print {
        @page {
            size: A4;
            margin: 1.5cm 1cm;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            background: white;
            font-family: Arial, sans-serif;
            font-size: 10pt;
            color: #000;
        }
        
        body > *:not(.print-section) {
            display: none !important;
        }
        
        .print-section {
            display: block !important;
            width: 100%;
            margin: 0;
            padding: 0;
            background: white;
        }
        
        .print-header {
            text-align: center;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #000;
            page-break-after: avoid;
        }
        
        .print-header h2 {
            font-size: 18pt;
            margin: 0 0 5px 0;
            line-height: 1.2;
            color: #000;
        }
        
        .print-header p {
            margin: 2px 0;
            font-size: 10pt;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 9pt;
            page-break-inside: avoid;
        }
        
        .print-table th, 
        .print-table td {
            border: 1px solid #000;
            padding: 4px 6px;
            text-align: left;
        }
        
        .print-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
        
        .print-table td {
            vertical-align: middle;
        }
        
        .tournament-info {
            margin: 10px 0;
            font-size: 10pt;
        }
        
        .tournament-info p {
            margin: 4px 0;
        }
        
        .print-section h3 {
            font-size: 12pt;
            margin: 15px 0 8px 0;
            padding-bottom: 3px;
            border-bottom: 1px solid #000;
            page-break-after: avoid;
        }
        
        .print-footer {
            position: fixed;
            bottom: 0;
            left: 1cm;
            right: 1cm;
            text-align: center;
            padding: 5px 0;
            background: white;
            border-top: 1px solid #000;
            font-size: 8pt;
            color: #666;
        }
        
        /* Ensure proper page breaks */
        .page-break {
            page-break-before: always;
        }
        
        /* Hide print button in print view */
        .no-print {
            display: none !important;
        }
    }

    /* Player removed styles */
    .player-removed {
        background-color: #fff0f0 !important;  /* Light red background */
        position: relative;
    }
    .player-removed::after {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: #dc3545;  /* Red border on the left */
    }
    .player-removed .player-name {
        position: relative;
        padding-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if tournament.status == 'completed' %}
    <div class="alert alert-info">
        <i class="fas fa-trophy me-2"></i>
        <strong>Tournament Completed</strong> - This tournament has been concluded and is now read-only.
    </div>
    {% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h1 class="mb-0">
            <i class="fas fa-trophy me-2"></i>{{ tournament.name }}
            <span class="badge bg-{{ 'success' if tournament.status == 'ongoing' else 'secondary' }} ms-2">
                {% if tournament.status == 'completed' %}
                <i class="fas fa-trophy me-1"></i>
            {% endif %}
            {{ tournament.status|title }}
            </span>
        </h1>
        {% if tournament.share_token %}
        <div class="dropdown ms-3">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="shareDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-share-alt me-1"></i> Share
            </button>
            <div class="dropdown-menu" aria-labelledby="shareDropdown">
                <h6 class="dropdown-header">Share Tournament</h6>
                <div class="px-3 py-2">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" class="form-control form-control-sm" id="shareLink" value="{{ url_for('public.view_tournament', token=tournament.share_token, _external=True) }}" readonly>
                        <button class="btn btn-outline-secondary btn-sm" type="button" id="copyLinkBtn" title="Copy to clipboard">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="https://wa.me/?text={{ ('Check out this tournament: ' + url_for('public.view_tournament', token=tournament.share_token, _external=True))|urlencode }}" 
                           class="btn btn-sm btn-success flex-grow-1" target="_blank">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        <a href="mailto:?subject={{ ('Tournament: ' + tournament.name)|urlencode }}&body={{ ('Check out this tournament: ' + url_for('public.view_tournament', token=tournament.share_token, _external=True))|urlencode }}" 
                           class="btn btn-sm btn-primary flex-grow-1" target="_blank">
                            <i class="far fa-envelope"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div>
        {% if tournament.status != 'completed' %}
            <a href="{{ url_for('tournament.manage_players', tournament_id=tournament.id) }}" class="btn btn-outline-primary me-2">
                <i class="fas fa-users me-1"></i> Manage Players
            </a>
            <a href="{{ url_for('tournament.manage_pairings', tournament_id=tournament.id) }}" class="btn btn-primary me-2">
                <i class="fas fa-chess-board me-1"></i> Manage Pairings
            </a>
            <a href="{{ url_for('tournament.manage_byes', tournament_id=tournament.id) }}" class="btn btn-outline-info me-2">
                <i class="fas fa-user-clock me-1"></i> Manage Byes
            </a>
            <a href="{{ url_for('tournament.rounds', tournament_id=tournament.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-list-ol me-1"></i> View All Rounds
            </a>
        {% else %}
            <button class="btn btn-outline-secondary me-2" disabled>
                <i class="fas fa-users me-1"></i> Manage Players
            </button>
            <button class="btn btn-secondary me-2" disabled>
                <i class="fas fa-chess-board me-1"></i> Manage Pairings
            </button>
            <button class="btn btn-outline-secondary me-2" disabled>
                <i class="fas fa-user-clock me-1"></i> Manage Byes
            </button>
            <a href="{{ url_for('tournament.rounds', tournament_id=tournament.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-list-ol me-1"></i> View All Rounds
            </a>
        {% endif %}
    </div>
</div>

<!-- Tournament Info -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><i class="far fa-calendar-alt me-2 text-muted"></i> 
                    <strong>Dates:</strong> {{ tournament.start_date|datetimeformat('%b %d, %Y') }} - {{ tournament.end_date|datetimeformat('%b %d, %Y') }}
                </p>
                <p><i class="fas fa-flag-checkered me-2 text-muted"></i> 
                    <strong>Rounds:</strong> {{ tournament.rounds }}
                </p>
                <p><i class="fas fa-users me-2 text-muted"></i> 
                    <strong>Players:</strong> {{ tournament.player_count }}
                </p>
            </div>
            <div class="col-md-6">
                <p><i class="fas fa-clock me-2 text-muted"></i> 
                    <strong>Time Control:</strong> {{ tournament.time_control or 'Not specified' }}
                </p>
                <p><i class="fas fa-map-marker-alt me-2 text-muted"></i> 
                    <strong>Location:</strong> {{ tournament.location or 'Not specified' }}
                </p>
                <p><i class="fas fa-info-circle me-2 text-muted"></i> 
                    <strong>Status:</strong> {{ tournament.status|title }}
                </p>
            </div>
        </div>
        {% if tournament.description %}
        <div class="mt-3">
            <h5>Description</h5>
            <p class="mb-0">{{ tournament.description }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Print Section -->
<div class="print-section d-none">
    <div class="print-header">
        <h2>{{ tournament.name }}</h2>
        <p>Tournament Overview</p>
        <p>{{ tournament.start_date|datetimeformat('%b %d, %Y') }}{% if tournament.end_date and tournament.end_date != tournament.start_date %} - {{ tournament.end_date|datetimeformat('%b %d, %Y') }}{% endif %}</p>
        <p>Printed: {{ now|datetimeformat('%b %d, %Y %I:%M %p') }}</p>
    </div>
    
    <div class="tournament-info">
        <p><strong>Round:</strong> {% if current_round %}Round {{ current_round.round_number }}{% else %}-{% endif %} | 
           <strong>Players:</strong> {{ tournament.player_count }} | 
           <strong>Status:</strong> {{ tournament.status|title }}</p>
        {% if tournament.description %}
            <p><strong>Description:</strong> {{ tournament.description }}</p>
        {% endif %}
    </div>
    
    {% if current_round %}
    <div class="current-round">
        <h3>Round {{ current_round.round_number }} Pairings</h3>
        {% if pairings %}
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Board</th>
                        <th>White</th>
                        <th>Rating</th>
                        <th>vs</th>
                        <th>Black</th>
                        <th>Rating</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pairing in pairings %}
                    <tr>
                        <td>{{ pairing.board_number }}</td>
                        <td>{{ pairing.white_name }}</td>
                        <td>{{ pairing.white_rating }}</td>
                        <td>vs</td>
                        <td>{{ pairing.black_name or 'BYE' }}</td>
                        <td>{{ pairing.black_rating or '' }}</td>
                        <td>{{ pairing.result or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No pairings available for this round.</p>
        {% endif %}
    </div>
    {% endif %}
    
    {% if standings %}
    <div class="standings">
        <h3>Current Standings</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Player</th>
                    <th>Pts</th>
                    <th>Buchholz</th>
                    <th>SB</th>
                </tr>
            </thead>
            <tbody>
                {% for item in standings %}
                <tr {% if item.status == 'withdrawn' %}class="player-removed"{% endif %}>
                    <td>{{ loop.index }}</td>
                    <td>{{ item.name }}{% if item.status == 'withdrawn' %} (Withdrawn){% endif %}</td>
                    <td>{{ '%.1f'|format(item.points) if item.points is number else item.points }}</td>
                    <td>{{ '%.1f'|format(item.buchholz) if item.buchholz is defined and item.buchholz is not none else '-' }}</td>
                    <td>{{ '%.1f'|format(item.sonneborn_berger) if item.sonneborn_berger is defined and item.sonneborn_berger is not none else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <div class="print-footer">
        {{ tournament.name }} • Generated on {{ now.strftime('%Y-%m-%d %H:%M') }} • Page <span class="page-number">1</span>
    </div>
</div>

<div class="row">
    <!-- Current Round -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chess-king me-2"></i>Current Round
                </h5>
            </div>
            <div class="card-body">
                {% if current_round %}
                    <h6 class="card-subtitle mb-3">
                        Round {{ current_round.round_number }} - {{ current_round.status|title }}
                    </h6>
                    {% if pairings %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Board</th>
                                        <th>White</th>
                                        <th>vs</th>
                                        <th>Black</th>
                                        <th>Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pairing in pairings %}
                                    <tr>
                                        <td>{{ pairing.board_number }}</td>
                                        <td class="{% if pairing.result == '1-0' %}fw-bold{% endif %}">
                                            {{ pairing.white_name }} ({{ pairing.white_rating }})
                                        </td>
                                        <td>vs</td>
                                        <td class="{% if pairing.result == '0-1' %}fw-bold{% endif %}">
                                            {{ pairing.black_name }} ({{ pairing.black_rating }})
                                        </td>
                                        <td>
                                            {% if pairing.result %}
                                                <span class="badge bg-{{ 'success' if pairing.result != '*' else 'secondary' }}">
                                                    {{ pairing.result }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-light text-dark">Pending</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            No pairings available for this round yet.
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning mb-0">
                        No active round. Start a new round to begin the tournament.
                    </div>
                {% endif %}
            </div>
            {% if current_round %}
            <div class="card-footer bg-transparent">
                <a href="{{ url_for('tournament.manage_pairings', tournament_id=tournament.id) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-edit me-1"></i> Manage Pairings
                </a>
                {% if current_round.status == 'ongoing' and pairings %}
                    <a href="#" class="btn btn-sm btn-success ms-2" data-bs-toggle="modal" data-bs-target="#completeRoundModal">
                        <i class="fas fa-flag-checkered me-1"></i> Complete Round
                    </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Top Standings -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Current Standings
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <a href="?view=individual" class="btn btn-sm {% if view_type == 'individual' %}btn-light{% else %}btn-outline-light{% endif %}">
                        <i class="fas fa-user me-1"></i> Players
                    </a>
                    <a href="?view=team" class="btn btn-sm {% if view_type == 'team' %}btn-light{% else %}btn-outline-light{% endif %}">
                        <i class="fas fa-users me-1"></i> Teams
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if standings %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>{% if view_type == 'team' %}Team{% else %}Player{% endif %}</th>
                                    {% if view_type != 'team' %}
                                        <th class="text-center">Team</th>
                                    {% endif %}
                                    <th class="text-center">Pts</th>
                                    {% if view_type == 'team' %}
                                        <th class="text-center">Players</th>
                                        <th class="text-center">Avg Pts</th>
                                    {% else %}
                                        <th class="text-center">TB1</th>
                                        <th class="text-center">TB2</th>
                                        <th class="text-center">Rating</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in standings[:10] %}
                                <tr class="{% if loop.index <= 3 %}table-{{ ['success', 'info', 'warning'][loop.index0] }}{% endif %} {% if item.status == 'withdrawn' %}player-removed{% endif %}">
                                    <td>{{ loop.index }}
                                        {% if item.status == 'withdrawn' %}
                                            <span class="badge bg-danger ms-1" title="Removed from tournament">X</span>
                                        {% endif %}
                                    </td>
                                    <td class="{% if item.status == 'withdrawn' %}text-muted{% endif %}">
                                        {% if view_type == 'team' %}
                                            <a href="#" class="text-decoration-none">
                                                {{ item.team }}
                                                {% if loop.index <= 3 %}
                                                    <span class="badge bg-{{ ['success', 'info', 'warning'][loop.index0] }} ms-1">
                                                        {{ loop.index|ordinal }}
                                                    </span>
                                                {% endif %}
                                                {% if item.player_count %}
                                                    <span class="badge bg-secondary ms-2">{{ item.player_count }} player{% if item.player_count != 1 %}s{% endif %}</span>
                                                {% endif %}
                                            </a>
                                        {% else %}
                                            <a href="#" class="text-decoration-none player-name" 
                                               data-tournament-id="{{ tournament.id }}"
                                               data-player-id="{{ item.id }}"
                                               data-player-name="{{ item.name|e }}"
                                               data-player-rating="{{ item.rating if item.rating is defined else '0' }}">
                                                {{ item.name }}
                                                {% if item.rating is defined and item.rating %}
                                                    <span class="text-muted small ms-1">({{ item.rating }})</span>
                                                {% endif %}
                                                {% if loop.index <= 3 %}
                                                    <span class="badge bg-{{ ['success', 'info', 'warning'][loop.index0] }} ms-1">
                                                        {{ loop.index|ordinal }}
                                                    </span>
                                                {% endif %}
                                            </a>
                                        {% endif %}
                                    </td>
                                    {% if view_type != 'team' %}
                                        <td class="text-center">{{ item.team or '—' }}</td>
                                    {% endif %}
                                    <td class="text-center fw-bold">
                                        {{ "%.1f"|format(item.total_points if view_type == 'team' else item.points) }}
                                    </td>
                                    {% if view_type == 'team' %}
                                        <td class="text-center">{{ item.player_count or '—' }}</td>
                                        <td class="text-center">{{ "%.2f"|format(item.avg_points_per_player) if item.avg_points_per_player is defined else '—' }}</td>
                                    {% else %}
                                        <td class="text-center">{{ "%.1f"|format(item.buchholz) if item.buchholz is defined else '—' }}</td>
                                        <td class="text-center">{{ "%.1f"|format(item.performance) if item.performance is defined else '—' }}</td>
                                        <td class="text-center">{{ item.rating if item.rating is defined else '—' }}</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if standings|length > 10 %}
                        <div class="text-center py-2 border-top">
                            <a href="{{ url_for('tournament.standings', tournament_id=tournament.id, view=view_type) }}" class="btn btn-sm btn-outline-primary">
                                View Full {{ 'Team' if view_type == 'team' else 'Player' }} Standings <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p class="mb-0">No players registered yet.</p>
                    </div>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                <a href="{{ url_for('tournament.standings', tournament_id=tournament.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list-ol me-1"></i> View Full Standings
                </a>
                <div>
                    <div class="btn-group" role="group">
                        {% if current_round %}
                            <a href="{{ url_for('tournament.export_pairings', tournament_id=tournament.id, round_id=current_round.id, format='csv') }}" class="btn btn-sm btn-outline-secondary me-2" title="Export Current Round (CSV)">
                                <i class="fas fa-file-csv me-1"></i> Export Round
                            </a>
                            <a href="{{ url_for('tournament.export_pairings', tournament_id=tournament.id, round_id=current_round.id, format='xlsx') }}" class="btn btn-sm btn-outline-secondary me-2" title="Export Current Round (Excel)">
                                <i class="fas fa-file-excel me-1"></i>
                            </a>
                            <a href="{{ url_for('tournament.view_round', round_id=current_round.id, print=1) }}" class="btn btn-sm btn-outline-secondary me-2" target="_blank" title="Print Round">
                                <i class="fas fa-print"></i>
                            </a>
                        {% endif %}
                        {% if tournament.status != 'completed' %}
                            <a href="{{ url_for('tournament.export_players', tournament_id=tournament.id) }}" class="btn btn-sm btn-outline-secondary me-2" title="Export Players">
                                <i class="fas fa-users me-1"></i> Players
                            </a>
                        {% endif %}
                        <a href="{{ url_for('tournament.export_results', tournament_id=tournament.id) }}" class="btn btn-sm btn-outline-secondary me-2" title="Export All Results (CSV)">
                            <i class="fas fa-file-csv me-1"></i> Results
                        </a>
                        <a href="{{ url_for('tournament.export_results', tournament_id=tournament.id, format='xlsx') }}" class="btn btn-sm btn-outline-secondary me-2" title="Export All Results (Excel)">
                            <i class="fas fa-file-excel"></i>
                        </a>
                        <a href="{{ url_for('tournament.standings', tournament_id=tournament.id, print=1) }}" class="btn btn-sm btn-outline-secondary" target="_blank" title="Print Standings">
                            <i class="fas fa-print"></i> Standings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tournament Actions -->
<div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Tournament Actions</h5>
        {% if tournament.status != 'completed' %}
        <form method="POST" action="{{ url_for('tournament.conclude_tournament', tournament_id=tournament.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-warning" 
                    onclick="return confirm('Are you sure you want to conclude this tournament? This action cannot be undone.')">
                <i class="fas fa-flag-checkered me-1"></i> Conclude Tournament
            </button>
        </form>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                        <h5 class="h6 mb-2">Manage Players</h5>
                        <p class="small text-muted mb-0">Add, remove, or edit tournament participants</p>
                        <a href="{{ url_for('tournament.manage_players', tournament_id=tournament.id) }}" class="stretched-link"></a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-success bg-opacity-10 text-success rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                            <i class="fas fa-chess-board fa-2x"></i>
                        </div>
                        <h5 class="h6 mb-2">Generate Pairings</h5>
                        <p class="small text-muted mb-0">Create pairings for the next round</p>
                        <a href="{{ url_for('tournament.manage_pairings', tournament_id=tournament.id) }}" class="stretched-link"></a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-info bg-opacity-10 text-info rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                            <i class="fas fa-file-export fa-2x"></i>
                        </div>
                        <h5 class="h6 mb-2">Export Results</h5>
                        <p class="small text-muted mb-0">Download tournament data in various formats</p>
                        <a href="#" class="stretched-link" data-bs-toggle="modal" data-bs-target="#exportModal"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Complete Round Modal -->
<div class="modal fade" id="completeRoundModal" tabindex="-1" aria-labelledby="completeRoundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="completeRoundModalLabel">Complete Round {{ current_round.round_number }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to complete the current round? This will:</p>
                <ul>
                    <li>Finalize all results</li>
                    <li>Update player ratings</li>
                    <li>Make the round results permanent</li>
                </ul>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmComplete">
                    <label class="form-check-label" for="confirmComplete">
                        I confirm all results have been entered correctly
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="completeRoundBtn" disabled>
                    <i class="fas fa-flag-checkered me-1"></i> Complete Round
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exportModalLabel">Export Tournament Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportFormat" class="form-label">Select Format</label>
                    <select class="form-select" id="exportFormat">
                        <option value="csv">CSV (Excel)</option>
                        <option value="pgn">PGN (Chess Games)</option>
                        <option value="json">JSON (Raw Data)</option>
                        <option value="html">HTML (Web Page)</option>
                    </select>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeGames" checked>
                    <label class="form-check-label" for="includeGames">
                        Include game moves (where applicable)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="exportBtn">
                    <i class="fas fa-download me-1"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Danger Zone - Only show to creator -->
{% if session.get('user_id') == tournament.creator_id %}
<div class="card border-danger mb-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Danger Zone</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-danger">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h6 class="alert-heading">Delete This Tournament</h6>
                    <p class="mb-0">This action cannot be undone. All tournament data including players, rounds, and pairings will be permanently deleted.</p>
                </div>
                <button type="button" class="btn btn-outline-danger ms-3" data-bs-toggle="modal" data-bs-target="#deleteTournamentModal">
                    <i class="fas fa-trash-alt me-1"></i> Delete Tournament
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTournamentModal" tabindex="-1" aria-labelledby="deleteTournamentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTournamentModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the tournament <strong>{{ tournament.name }}</strong>? This action cannot be undone.</p>
                <p class="text-danger"><strong>Warning:</strong> All tournament data including players, rounds, and pairings will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <form action="{{ url_for('tournament.delete_tournament', tournament_id=tournament.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Delete Permanently
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Copy share link to clipboard
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', function() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            
            // Change button icon to checkmark temporarily
            const icon = this.querySelector('i');
            const originalIcon = icon.className;
            icon.className = 'fas fa-check';
            
            // Revert back after 2 seconds
            setTimeout(() => {
                icon.className = originalIcon;
            }, 2000);
        });
    }
    
    // Enable/disable complete round button based on confirmation
    const confirmComplete = document.getElementById('confirmComplete');
    const completeRoundBtn = document.getElementById('completeRoundBtn');
    
    if (confirmComplete && completeRoundBtn) {
        confirmComplete.addEventListener('change', function() {
            completeRoundBtn.disabled = !this.checked;
        });
        
        completeRoundBtn.addEventListener('click', function() {
            // Add your complete round logic here
            // For example, submit a form or make an AJAX call
            alert('Round completed successfully!');
            $('#completeRoundModal').modal('hide');
            // Reload the page to show updated data
            window.location.reload();
        });
    }
    
    // Export button handler
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const format = document.getElementById('exportFormat').value;
            const includeGames = document.getElementById('includeGames').checked;
            
            // Add your export logic here
            alert(`Exporting as ${format.toUpperCase()} (Include Games: ${includeGames})`);
            $('#exportModal').modal('hide');
            
            // Example of how you might trigger a download
            // window.location.href = `/tournaments/{{ tournament.id }}/export?format=${format}&include_games=${includeGames}`;
        });
    }
});
</script>
{% endblock %}
{% endblock %}
