{% extends "base.html" %}

{% block title %}Reset Password - Zugzwang Pairings System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
{% endblock %}

{% block content %}
<div class="auth-page">
    <div class="auth-card">
        {% if not valid_token %}
            <div class="auth-header">
                <h1><i class="fas fa-exclamation-triangle me-2"></i>Invalid Link</h1>
                <p>This password reset link is invalid or has expired</p>
            </div>
            
            <div class="auth-body">
                <div class="alert-auth alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>Please request a new password reset link to continue.</div>
                </div>
                
                <div class="d-grid gap-3">
                    <a href="{{ url_for('auth.forgot_password') }}" class="btn btn-primary">
                        <i class="fas fa-key me-2"></i>Request New Reset Link
                    </a>
                    
                    <div class="divider">
                        <span>OR</span>
                    </div>
                    
                    <a href="{{ url_for('auth.login') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Login
                    </a>
                </div>
            </div>
        {% else %}
            <div class="auth-header">
                <h1><i class="fas fa-key me-2"></i>Reset Password</h1>
                <p>Enter your new password below</p>
            </div>
            
            <div class="auth-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert-auth {% if category == 'success' %}alert-success{% else %}alert-danger{% endif %}">
                                <i class="{% if category == 'success' %}fas fa-check-circle{% else %}fas fa-exclamation-circle{% endif %}"></i>
                                <div>{{ message }}</div>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form method="POST" action="{{ url_for('auth.reset_password', token=token) }}" class="auth-form" novalidate>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="form-floating mb-3">
                        <input type="password" 
                               class="form-control" 
                               id="password" 
                               name="password" 
                               placeholder="New password" 
                               required
                               minlength="8">
                        <label for="password">New Password</label>
                        <div class="form-text">Must be at least 8 characters long</div>
                    </div>
                    
                    <div class="form-floating mb-4">
                        <input type="password" 
                               class="form-control" 
                               id="confirm_password" 
                               name="confirm_password" 
                               placeholder="Confirm password" 
                               required
                               minlength="8">
                        <label for="confirm_password">Confirm Password</label>
                        <div id="passwordMatch" class="form-text"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-auth">
                        <i class="fas fa-save"></i> Reset Password
                    </button>
                    
                    <div class="divider">
                        <span>OR</span>
                    </div>
                </form>
                
                <div class="auth-footer">
                    Remember your password? <a href="{{ url_for('auth.login') }}">Sign in</a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% if valid_token %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle password visibility
        const togglePassword = (inputId) => {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        };
        
        // Add password toggle buttons
        const passwordInputs = document.querySelectorAll('.form-floating input[type="password"]');
        passwordInputs.forEach(input => {
            const wrapper = input.parentElement;
            wrapper.style.position = 'relative';
            
            const toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'btn btn-sm btn-link text-muted position-absolute end-0 top-0 me-2 mt-3';
            toggleBtn.style.zIndex = '10';
            toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
            toggleBtn.onclick = () => togglePassword(input.id);
            
            wrapper.appendChild(toggleBtn);
        });
        
        // Password match validation
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirm_password');
        const passwordMatch = document.getElementById('passwordMatch');
        
        function validatePasswordMatch() {
            if (password && confirmPassword && passwordMatch) {
                if (password.value && confirmPassword.value) {
                    if (password.value !== confirmPassword.value) {
                        passwordMatch.innerHTML = '<i class="fas fa-times text-danger me-1"></i>Passwords do not match';
                        confirmPassword.setCustomValidity("Passwords do not match");
                    } else {
                        passwordMatch.innerHTML = '<i class="fas fa-check text-success me-1"></i>Passwords match';
                        confirmPassword.setCustomValidity("");
                    }
                } else {
                    passwordMatch.textContent = '';
                    confirmPassword.setCustomValidity("");
                }
            }
        }
        
        if (password && confirmPassword) {
            password.addEventListener('input', validatePasswordMatch);
            confirmPassword.addEventListener('input', validatePasswordMatch);
            
            // Form validation
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (password.value !== confirmPassword.value) {
                        e.preventDefault();
                        passwordMatch.innerHTML = '<i class="fas fa-times text-danger me-1"></i>Passwords do not match';
                        confirmPassword.focus();
                    }
                });
            }
        }
    });
</script>
{% endblock %}
{% endif %}
